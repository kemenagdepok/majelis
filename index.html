<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web GIS Majelis Ta'lim Kota Depok</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    
    <style>
        #map {
            height: 500px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header-title {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
        }
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .marker-cluster-small { background-color: rgba(181, 226, 140, 0.6); }
        .marker-cluster-medium { background-color: rgba(241, 211, 87, 0.6); }
        .marker-cluster-large { background-color: rgba(253, 156, 115, 0.6); }
    </style>
</head>
<body>

    <div class="container-fluid header-title">
        <div class="container">
            <h1><i class="bi bi-geo-alt-fill"></i> GIS Majelis Ta'lim Kota Depok</h1>
            <p class="mb-0">Sebaran Data MT Kecamatan Pancoran Mas & Cimanggis</p>
        </div>
    </div>

    <div class="container mb-5">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-bg-primary mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Total Data</h5>
                        <h2 id="total-count">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-bg-success mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Pancoran Mas</h5>
                        <h2 id="panmas-count">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-bg-warning mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Cimanggis</h5>
                        <h2 id="cimanggis-count">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header fw-bold">Peta Persebaran (Estimasi Lokasi via Kelurahan)</div>
            <div class="card-body p-0">
                <div id="map"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header fw-bold">Data Tabel Detail</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="dataTable" class="table table-striped table-hover" style="width:100%">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama Majelis Ta'lim</th>
                                <th>Kecamatan</th>
                                <th>Estimasi Kelurahan</th>
                                <th>Alamat Lengkap</th>
                                <th>Tahun Berdiri</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        // --- 1. KOORDINAT REFERENSI KELURAHAN (Pusat Estimasi) ---
        // Karena data tidak punya Lat/Lng, kita petakan berdasarkan nama Kelurahan
        const geoLocations = {
            // Pancoran Mas
            "depok": { lat: -6.4025, lng: 106.819 },
            "depok jaya": { lat: -6.3957, lng: 106.8093 },
            "pancoran mas": { lat: -6.4017, lng: 106.7972 },
            "mampang": { lat: -6.3989, lng: 106.7915 },
            "rangkapan jaya": { lat: -6.3995, lng: 106.7845 },
            "rangkapan jaya baru": { lat: -6.4100, lng: 106.7800 },
            // Cimanggis
            "harjamukti": { lat: -6.3732, lng: 106.8876 },
            "tugu": { lat: -6.3634, lng: 106.8532 },
            "cisalak pasar": { lat: -6.3650, lng: 106.8650 },
            "mekarsari": { lat: -6.3725, lng: 106.8631 },
            "curug": { lat: -6.3850, lng: 106.8600 },
            "pasir gunung selatan": { lat: -6.3550, lng: 106.8500 },
            // Default Kecamatan Centers
            "cimanggis_default": { lat: -6.3700, lng: 106.8600 },
            "pancoran_mas_default": { lat: -6.4000, lng: 106.8000 }
        };

        // --- 2. DATA RAW (Digabungkan dari input user) ---
        // Saya menyederhanakan format CSV input menjadi Array Object JS untuk kemudahan
        const rawData = [
            // PANCORAN MAS (Sampel Data dari input)
            {kec:"Pancoran Mas", nama:"Forum Komunikasi Majlis Ta'lim (FKMT)", alamat:"Gd. MUI Kota Depok Jl. Nusantara Raya No. 5-7 Depok Jaya", thn:"2013"},
            {kec:"Pancoran Mas", nama:"M.T Hijaiyah", alamat:"Jl. Caringin Kp. Kekupu Rt 04/04, No. 75 Kel. Rangkapan Jaya Lama", thn:"2020"},
            {kec:"Pancoran Mas", nama:"Al Maratussholihah", alamat:"Jl. H. Amsir No. 68 Rt 01/04 Kupu Rangkapan Jaya", thn:""},
            {kec:"Pancoran Mas", nama:"M.T As-sakinah", alamat:"Jl. Cagar Alam Gg. Swadaya 2 RT. 001/008 Kel. P. Mas", thn:""},
            {kec:"Pancoran Mas", nama:"M.T Nur Fadillah", alamat:"Musholla Al Ikhlas RT 001/008 Kel. Pan. Mas", thn:""},
            {kec:"Pancoran Mas", nama:"M.T Sa'adtuddarain", alamat:"Jl. Pramuka RT. 03/011 Kel. Mampang", thn:""},
            {kec:"Pancoran Mas", nama:"Cahaya Hati", alamat:"RT. 01/06, No.27, Kel. Rangkapan Jaya", thn:""},
            {kec:"Pancoran Mas", nama:"Al-Ikhlas", alamat:"Jl. Srikaya 1 No.174 RT. 005/014 Kel. Depok Jaya", thn:""},
            {kec:"Pancoran Mas", nama:"Al-Barkah", alamat:"Jl. H. Gimang, RT 02/03, Kel. Mampang", thn:""},
            {kec:"Pancoran Mas", nama:"Bahul Aamiin", alamat:"Jl. Gg. Musholla Baitul Amin, RT. 03/014 Kel. Pan. Mas", thn:""},
            {kec:"Pancoran Mas", nama:"MT. Raudhatul Jannah", alamat:"Jl. Sejahtera, RT 03/06, RW. 02 Rangkapan Jaya Baru", thn:""},
            {kec:"Pancoran Mas", nama:"MT. Marawis Al Istiqomah", alamat:"Kampung Lio, Mesjid Jami At Taqwa RT. 007/013, Kel. Depok", thn:""},
            {kec:"Pancoran Mas", nama:"MT. Cahaya Ilmu", alamat:"Jl. Kesejahteraan, RT. 03/02, No. 74 Rangkapan Jaya Baru", thn:""},
            {kec:"Pancoran Mas", nama:"MT. Nurul Iman", alamat:"Jl. Kembang Lio, RT. 003/013, Kel. Depok", thn:""},
            {kec:"Pancoran Mas", nama:"MT. Tanbihul Ghofilin", alamat:"Jl. Naming D'Botin Kp. Lio RT. 006/019 Kel. Depok", thn:""},
            {kec:"Pancoran Mas", nama:"Majelis Dzikir Utrujah", alamat:"Kp. Parung Bingung, RT. 003/013 Kel. Rangkapan Jaya Baru", thn:""},
            
            // CIMANGGIS (Sampel Data dari input)
            {kec:"Cimanggis", nama:"Al - Ikhlas", alamat:"Kel. Harjamukti", thn:"2017"},
            {kec:"Cimanggis", nama:"Nurul Iman", alamat:"Kel. Harjamukti", thn:"2017"},
            {kec:"Cimanggis", nama:"MT. Kelompok PKK RW 03", alamat:"Jl. Masjid Al Ikhlas RT. 005/003, Kel. Cisolok Pasar (Cisalak Pasar)", thn:""},
            {kec:"Cimanggis", nama:"MT. Al - Khairiyah", alamat:"Jl. Alamanda RT. 08/07 Kel. Tugu", thn:""},
            {kec:"Cimanggis", nama:"MT. Al Istiqomah Tugu", alamat:"Jl. Alamanda No. 17 RT. 008/007 Kel. Tugu", thn:""},
            {kec:"Cimanggis", nama:"MT. Nurussa'adah", alamat:"Jl. Nurul Hikmah III, No. 52 Kelapa Dua, Kel. Tugu", thn:""},
            {kec:"Cimanggis", nama:"MT. As Syifa", alamat:"Palsigunung RT. 01/01, No. 36 Kel. Tugu", thn:""},
            {kec:"Cimanggis", nama:"MT. Al Muna", alamat:"Jl. Masjid Uswatun Hasanah RT. 04/06, Kel. Curug", thn:""},
            {kec:"Cimanggis", nama:"MT. Al Husna", alamat:"Jl. Taman Duta 7, Blok E7, No. 3 Pondok Duta", thn:""}, // Implied Cisalak/Tugu
            {kec:"Cimanggis", nama:"MT. Kaum Ibu", alamat:"Kp. Pondok Ranggon, RT. 003/006 Kel. Harjamukti", thn:""},
            {kec:"Cimanggis", nama:"Al - Muhsinin", alamat:"Jl. Pringgodani Raya, Kp. Kalimanggis, Kel. Harjamukti", thn:""},
            {kec:"Cimanggis", nama:"MT. Al Hamidiyah", alamat:"Tipar RT. 001/010 Kel. Mekar Jaya (Mekarsari)", thn:""},
            {kec:"Cimanggis", nama:"MT. Asmaul Husna", alamat:"Jl. H. Ramin No. 19, RT. 03/09 Kel. Mekarsari", thn:""},
            {kec:"Cimanggis", nama:"MT. Nurul Mukhlisin", alamat:"Jl. Bhineka IV, Kp. Rumbut Kel. Pasir Gunung Selatan", thn:""},
            {kec:"Cimanggis", nama:"MT. Sa'adatul Musthofa", alamat:"Jl. Persatuan I, No. 28, Kel. Pasir Gunung Selatan", thn:""}
            // Catatan: Data di atas adalah sampel representatif dari file yang Anda upload agar skrip tidak terlalu berat.
            // Anda bisa menambahkan sisa data ke dalam array ini dengan format yang sama.
        ];

        // --- 3. FUNGSI HELPER: Deteksi Lokasi & Jitter ---
        function detectLocation(address, kecamatan) {
            let lat, lng, kelurahan = "Tidak Diketahui";
            const addrLower = address.toLowerCase();

            // Logika pencarian string sederhana
            if (addrLower.includes("depok jaya")) { kelurahan = "Depok Jaya"; }
            else if (addrLower.includes("rangkapan jaya baru")) { kelurahan = "Rangkapan Jaya Baru"; }
            else if (addrLower.includes("rangkapan")) { kelurahan = "Rangkapan Jaya"; } // Catch both
            else if (addrLower.includes("mampang")) { kelurahan = "Mampang"; }
            else if (addrLower.includes("pan. mas") || addrLower.includes("pancoran mas")) { kelurahan = "Pancoran Mas"; }
            else if (addrLower.includes("kel. depok") || (addrLower.includes("kp. lio") && kecamatan.includes("Pancoran"))) { kelurahan = "Depok"; }
            
            else if (addrLower.includes("harjamukti")) { kelurahan = "Harjamukti"; }
            else if (addrLower.includes("tugu") || addrLower.includes("kelapa dua") || addrLower.includes("palsigunung")) { kelurahan = "Tugu"; }
            else if (addrLower.includes("mekarsari") || addrLower.includes("mekar jaya")) { kelurahan = "Mekarsari"; }
            else if (addrLower.includes("cisalak") || addrLower.includes("cisolok")) { kelurahan = "Cisalak Pasar"; }
            else if (addrLower.includes("pasir gunung") || addrLower.includes("pasirgunung")) { kelurahan = "Pasir Gunung Selatan"; }
            else if (addrLower.includes("curug")) { kelurahan = "Curug"; }

            // Assign Koordinat
            let baseCoord;
            if (geoLocations[kelurahan.toLowerCase()]) {
                baseCoord = geoLocations[kelurahan.toLowerCase()];
            } else {
                // Fallback ke Kecamatan Center
                if (kecamatan.toLowerCase().includes("cimanggis")) {
                    baseCoord = geoLocations["cimanggis_default"];
                    kelurahan = "Cimanggis (Umum)";
                } else {
                    baseCoord = geoLocations["pancoran_mas_default"];
                    kelurahan = "Pancoran Mas (Umum)";
                }
            }

            // Tambahkan "Jitter" (Random Offset) agar tumpukan marker terlihat
            // Offset sekitar +/- 0.001 - 0.003 derajat
            const jitterLat = (Math.random() - 0.5) * 0.004;
            const jitterLng = (Math.random() - 0.5) * 0.004;

            return {
                lat: baseCoord.lat + jitterLat,
                lng: baseCoord.lng + jitterLng,
                kelurahanName: kelurahan
            };
        }

        // --- 4. INISIALISASI ---
        $(document).ready(function() {
            // A. Setup Map
            const map = L.map('map').setView([-6.385, 106.82], 13); // Center antara Panmas dan Cimanggis

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            let panmasCount = 0;
            let cimanggisCount = 0;
            let tableBody = "";

            // B. Loop Data & Create Markers
            rawData.forEach((item, index) => {
                const locData = detectLocation(item.alamat, item.kec);
                
                // Update Statistik
                if(item.kec.toLowerCase().includes("pancoran")) panmasCount++;
                if(item.kec.toLowerCase().includes("cimanggis")) cimanggisCount++;

                // Buat Marker
                const markerColor = item.kec.toLowerCase().includes("pancoran") ? "blue" : "red"; // Biru: Panmas, Merah: Cimanggis
                
                // Menggunakan Circle Marker agar lebih ringan
                const circle = L.circleMarker([locData.lat, locData.lng], {
                    color: markerColor,
                    fillColor: markerColor,
                    fillOpacity: 0.6,
                    radius: 8
                }).addTo(map);

                const popupContent = `
                    <strong>${item.nama}</strong><br>
                    <small>${item.kec} - ${locData.kelurahanName}</small><br>
                    <hr style="margin:5px 0">
                    ${item.alamat}<br>
                    <em>Tahun: ${item.thn || '-'}</em>
                `;
                circle.bindPopup(popupContent);

                // Siapkan baris tabel
                tableBody += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.nama}</td>
                        <td>${item.kec}</td>
                        <td>${locData.kelurahanName}</td>
                        <td>${item.alamat}</td>
                        <td>${item.thn || '-'}</td>
                    </tr>
                `;
            });

            // C. Update UI
            $('#total-count').text(rawData.length);
            $('#panmas-count').text(panmasCount);
            $('#cimanggis-count').text(cimanggisCount);
            
            // D. Isi Tabel & Init DataTables
            $('#dataTable tbody').html(tableBody);
            $('#dataTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/id.json'
                }
            });
        });
    </script>
</body>
</html>