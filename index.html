<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIS Majelis Ta'lim Kota Depok (Fixed)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .navbar { background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); }
        #map { height: 650px; width: 100%; border-radius: 8px; border: 3px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .badge-kec { cursor: pointer; transition: 0.2s; }
        .badge-kec:hover { background-color: #0d6efd !important; }
        .legend-box { background: white; padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 12px; }
        .leaflet-popup-content { font-size: 13px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark mb-4 shadow-sm">
        <div class="container-fluid px-4">
            <span class="navbar-brand mb-0 h1"><i class="bi bi-map-fill me-2"></i>SIG Majelis Ta'lim Depok</span>
            <span class="text-white small">Total Data: <span id="total-count" class="fw-bold text-warning">0</span> Lokasi</span>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-2 position-relative">
                        <div id="map"></div>
                        
                        <div class="position-absolute bottom-0 start-0 m-3 legend-box" style="z-index: 999;">
                            <div class="mb-1"><i class="bi bi-square-fill text-primary opacity-50"></i> Batas Kecamatan</div>
                            <div class="mb-1"><i class="bi bi-square-fill text-success opacity-25"></i> Batas Kelurahan</div>
                            <div><i class="bi bi-circle-fill text-danger"></i> Lokasi MT</div>
                        </div>
                    </div>
                    <div class="card-footer bg-white d-flex justify-content-between">
                        <small class="text-muted fst-italic">Klik area pada peta untuk filter tabel otomatis.</small>
                        <button class="btn btn-sm btn-outline-danger" onclick="resetAll()"><i class="bi bi-arrow-counterclockwise"></i> Reset Tampilan</button>
                    </div>
                </div>
            </div>

            <div class="col-lg-12 mb-5">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white fw-bold py-3">
                        <i class="bi bi-table me-2"></i>Daftar Majelis Ta'lim
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="mtTable" class="table table-hover table-striped w-100 align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th width="5%">No</th>
                                        <th>Nama Majelis Ta'lim</th>
                                        <th>Kecamatan</th>
                                        <th>Kelurahan (Est)</th>
                                        <th>Alamat Lengkap</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        // ==========================================
        // 1. DATA (Embedded dari File Upload Anda)
        // ==========================================
        
        // Data MT (439 Record dari CSV)
        const mtData = `
        ${mt_data_json}
        `; // Placeholder Python akan mengisi ini
        const parsedMTData = JSON.parse(mtData);

        // Data Kecamatan (dari kecamatan.geojson)
        const kecData = `
        ${kec_data_json}
        `; // Placeholder Python akan mengisi ini
        const parsedKecData = JSON.parse(kecData);

        // Data Kelurahan (dari kelurahan.geojson)
        const kelData = `
        ${kel_data_json}
        `; // Placeholder Python akan mengisi ini
        const parsedKelData = JSON.parse(kelData);

        // ==========================================
        // 2. LOGIKA UTAMA
        // ==========================================

        const distrikCenters = {
            "Beji": { lat: -6.372, lng: 106.812 }, "Bojongsari": { lat: -6.408, lng: 106.745 },
            "Cilodong": { lat: -6.431, lng: 106.840 }, "Cimanggis": { lat: -6.370, lng: 106.860 },
            "Cinere": { lat: -6.335, lng: 106.785 }, "Cipayung": { lat: -6.425, lng: 106.790 },
            "Limo": { lat: -6.365, lng: 106.775 }, "Pancoran Mas": { lat: -6.400, lng: 106.797 },
            "Sawangan": { lat: -6.405, lng: 106.765 }, "Sukmajaya": { lat: -6.390, lng: 106.845 },
            "Tapos": { lat: -6.420, lng: 106.880 }
        };

        let map, table;
        let layerKec, layerKel, layerPoints;

        $(document).ready(function() {
            // A. Update Stats
            $('#total-count').text(parsedMTData.length);

            // B. Init Table
            table = $('#mtTable').DataTable({
                data: parsedMTData,
                columns: [
                    { data: null, render: (d,t,r,m) => m.row + 1 },
                    { data: 'nama', className: 'fw-bold text-primary' },
                    { data: 'kecamatan', render: d => `<span class="badge bg-secondary badge-kec" onclick="filterByKec('${d}')">${d}</span>` },
                    { data: null, render: d => detectKelurahan(d.alamat) || '-' },
                    { data: 'alamat' }
                ],
                language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/id.json" },
                pageLength: 5,
                lengthMenu: [5, 10, 25, 50]
            });

            // C. Init Map
            map = L.map('map').setView([-6.395, 106.810], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap, CartoDB'
            }).addTo(map);

            let layerControl = L.control.layers(null, null, { collapsed: false }).addTo(map);

            // 1. Layer Kecamatan (Garis Biru)
            layerKec = L.geoJSON(parsedKecData, {
                style: { color: "#0d6efd", weight: 2, fillOpacity: 0.05, dashArray: '5,5' },
                onEachFeature: function(feature, layer) {
                    let name = feature.properties.nm_kecamatan || "Kecamatan";
                    layer.bindTooltip(name, { sticky: true, direction: 'center', className: 'fw-bold text-primary' });
                    layer.on('click', function() {
                        resetStyles();
                        layer.setStyle({ weight: 4, fillOpacity: 0.2, color: '#0d6efd', dashArray: '' });
                        map.fitBounds(layer.getBounds());
                        filterByKec(name);
                    });
                }
            }).addTo(map);
            layerControl.addOverlay(layerKec, "Batas Kecamatan");

            // 2. Layer Kelurahan (Garis Hijau)
            layerKel = L.geoJSON(parsedKelData, {
                style: { color: "#198754", weight: 1, fillOpacity: 0, dashArray: '2,4' },
                onEachFeature: function(feature, layer) {
                    let name = feature.properties.nm_kelurahan || "Kelurahan";
                    layer.bindTooltip(name, { sticky: true });
                    layer.on('click', function() {
                        resetStyles();
                        layer.setStyle({ weight: 3, fillOpacity: 0.2, color: '#198754', dashArray: '' });
                        map.fitBounds(layer.getBounds());
                        filterByKel(name);
                    });
                }
            }).addTo(map);
            layerControl.addOverlay(layerKel, "Batas Kelurahan");

            // 3. Layer Titik MT
            let markers = [];
            parsedMTData.forEach(item => {
                let kecKey = Object.keys(distrikCenters).find(k => item.kecamatan.includes(k)) || "Pancoran Mas";
                let base = distrikCenters[kecKey];
                
                // Jitter (Acak posisi sedikit agar tidak menumpuk)
                let lat = base.lat + (Math.random() - 0.5) * 0.025;
                let lng = base.lng + (Math.random() - 0.5) * 0.025;

                let marker = L.circleMarker([lat, lng], {
                    radius: 5,
                    fillColor: "#dc3545",
                    color: "white",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup(`
                    <div class='text-center'>
                        <strong class='text-primary'>${item.nama}</strong><br>
                        <span class='badge bg-light text-dark border mt-1'>${item.kecamatan}</span>
                        <hr class='my-1'>
                        <small>${item.alamat}</small>
                    </div>
                `);
                markers.push(marker);
            });
            layerPoints = L.layerGroup(markers).addTo(map);
            layerControl.addOverlay(layerPoints, "Titik Majelis Ta'lim");
        });

        // --- Helper Functions ---
        function resetStyles() {
            if(layerKec) layerKec.resetStyle();
            if(layerKel) layerKel.resetStyle();
        }

        function filterByKec(name) {
            let clean = name.replace(/kecamatan/gi, "").trim();
            table.search(clean).draw();
        }

        function filterByKel(name) {
            let clean = name.replace(/kelurahan|desa/gi, "").trim();
            table.search(clean).draw();
        }

        function resetAll() {
            resetStyles();
            map.setView([-6.395, 106.810], 12);
            table.search('').draw();
        }

        function detectKelurahan(addr) {
            if(!addr) return "";
            let match = addr.match(/(?:Kel\.|Kelurahan)\s*([A-Za-z\s]+?)(?:,|$)/i);
            return match ? match[1].trim() : "";
        }
    </script>
</body>
</html>